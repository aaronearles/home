# VyOS Firewall Rules Configuration Template
# Purpose: Generate input and forward filter rules

{# Global Firewall Options #}
{% if firewall_global_options is defined %}
{% for policy, action in firewall_global_options.state_policy.items() %}
set firewall global-options state-policy {{ policy }} action '{{ action }}'
{% endfor %}
{% endif %}

{# Default Actions #}
set firewall ipv4 input filter default-action drop
set firewall ipv4 forward filter default-action drop

{# Input Filter Rules #}
{# Allow established and related connections #}
set firewall ipv4 input filter rule 10 action accept
set firewall ipv4 input filter rule 10 state established
set firewall ipv4 input filter rule 10 state related

{# Allow loopback traffic #}
set firewall ipv4 input filter rule 20 action accept
set firewall ipv4 input filter rule 20 inbound-interface name lo

{# Allow SSH from trusted networks #}
{% if firewall_groups.network_groups.NET_INSIDE is defined %}
set firewall ipv4 input filter rule 30 action accept
set firewall ipv4 input filter rule 30 protocol tcp
set firewall ipv4 input filter rule 30 destination port 22
set firewall ipv4 input filter rule 30 source group network-group NET-INSIDE
{% endif %}

{# Forward Filter Rules #}
{# Allow established and related connections #}
set firewall ipv4 forward filter rule 10 action accept
set firewall ipv4 forward filter rule 10 state established
set firewall ipv4 forward filter rule 10 state related

{# Allow internal to external traffic #}
{% if firewall_groups.network_groups.NET_INSIDE is defined and firewall_groups.network_groups.NET_OUTSIDE is defined %}
set firewall ipv4 forward filter rule 20 action accept
set firewall ipv4 forward filter rule 20 source group network-group NET-INSIDE
set firewall ipv4 forward filter rule 20 destination group network-group NET_OUTSIDE
{% endif %}

{# Allow common services from internal networks #}
{% if firewall_groups.network_groups.NET_INSIDE is defined %}
set firewall ipv4 forward filter rule 30 action accept
set firewall ipv4 forward filter rule 30 source group network-group NET-INSIDE
set firewall ipv4 forward filter rule 30 protocol tcp
set firewall ipv4 forward filter rule 30 destination port 80,443,53

set firewall ipv4 forward filter rule 40 action accept
set firewall ipv4 forward filter rule 40 source group network-group NET-INSIDE
set firewall ipv4 forward filter rule 40 protocol udp
set firewall ipv4 forward filter rule 40 destination port 53,123
{% endif %}